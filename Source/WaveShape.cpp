/*
    Copyright 2020 Barabas Raffai

    This file is part of Valvestate Sim.

    Valvestate Sim is free software: you can redistribute it and/or modify it
    under the terms of the GNU General Public License as published by the Free
    Software Foundation, either version 3 of the License, or (at your option)
    any later version.

    Valvestate Sim is distributed in the hope that it will be useful, but
    WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
    or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
    for more details.

    You should have received a copy of the GNU General Public License along
    with Valvestate Sim.  If not, see <https://www.gnu.org/licenses/>.
*/

#include "WaveShape.h"
#include <math.h>
#include <stddef.h>

#define ARRAY_LENGTH(a) (sizeof(a)/sizeof(a[0]))

static const float SHAPE[] = {
        260.874, 260.7859598, 260.6953072,  260.601432, 260.5041537,
    260.4031856, 260.2985207, 260.1896056,  260.076319, 259.9582966,
    259.8351546, 259.7065092, 259.5718914, 259.4308215, 259.2828199,
    259.1270814, 258.9629027, 258.7895337, 258.6060523, 258.4113474,
    258.2040441, 257.9827768, 257.7457712, 257.4909677,  257.215841,
    256.9175018, 256.5922455, 256.2355875, 255.8419352, 255.4041851,
    254.9131986, 254.3570307, 253.7197414, 252.9797121, 252.1071154,
    251.0601723, 249.8186298, 248.2374011, 246.2379769, 243.6984809,
    240.5224287, 236.6969109, 232.3051762, 227.4657723, 222.2539886,
    216.6160464, 210.1628519, 202.9424278, 195.5356801, 188.0209338,
    180.4120106, 172.7204129, 164.9578739,  157.138341, 149.2820719,
    141.4227325, 133.6224484, 125.9975098, 118.7442167, 112.1250619,
    106.3720184,  101.573245,  97.7060744, 94.80219447, 92.84731645,
     91.5876897, 90.69125858,  90.0247106, 89.50066273, 89.07172653,
    88.71016277, 88.39855163, 88.12531192, 87.88239154, 87.66399733,
    87.46582419, 87.28474325, 87.11794571, 86.96342626, 86.81954855,
    86.68498918, 86.55863586,  86.4395753, 86.32702159, 86.22032926,
    86.11890837, 86.02227577, 85.93001157, 85.84172799, 85.75711414,
    85.67586468,  85.5977274, 85.52247784, 85.44990292, 85.37981384,
    85.31205745, 85.24646844, 85.18291616, 85.12127864,    85.06124,
};

/* Exported with 10x greater input range, for softer clipping at the extremes */
static const float EXTENDED_SHAPE[] = {
       266.6353, 266.6328032, 266.6303065, 266.6278097,  266.625313, 
    266.6228162, 266.6203195, 266.6178227,  266.615326, 266.6128292, 
    266.6103324, 266.6077469, 266.6051564,  266.602566, 266.5999755, 
     266.597385, 266.5947945,  266.592204, 266.5896136, 266.5870231, 
    266.5844326,  266.581772, 266.5790838, 266.5763955, 266.5737073, 
    266.5710191, 266.5683308, 266.5656426, 266.5629544, 266.5602661, 
    266.5575779, 266.5548372, 266.5520415, 266.5492457,   266.54645, 
    266.5436542, 266.5408584, 266.5380627, 266.5352669, 266.5324711, 
    266.5296754, 266.5268469,  266.523924, 266.5210012, 266.5180783, 
    266.5151555, 266.5122326, 266.5093098, 266.5063869, 266.5034641, 
    266.5005413, 266.4976154,  266.494585, 266.4915547, 266.4885243, 
    266.4854939, 266.4824635, 266.4794332, 266.4764028, 266.4733724, 
     266.470342, 266.4673117, 266.4641799, 266.4610224,  266.457865, 
    266.4547075,   266.45155, 266.4483926, 266.4452351, 266.4420777, 
    266.4389202, 266.4357628,  266.432522, 266.4292179, 266.4259138, 
    266.4226097, 266.4193056, 266.4160015, 266.4126975, 266.4093934, 
    266.4060893, 266.4027852, 266.3994348, 266.3959938, 266.3925529, 
     266.389112,  266.385671, 266.3822301, 266.3787891, 266.3753482, 
    266.3719072, 266.3684663, 266.3650083,  266.361411, 266.3578136, 
    266.3542163, 266.3506189, 266.3470216, 266.3434243, 266.3398269, 
    266.3362296, 266.3326322, 266.3290349,    266.3253, 266.3215463, 
    266.3177925, 266.3140388,  266.310285, 266.3065312, 266.3027775, 
    266.2990237,   266.29527, 266.2915162, 266.2876482, 266.2837185, 
    266.2797888, 266.2758591, 266.2719294, 266.2679997,   266.26407, 
    266.2601402, 266.2562105, 266.2522808, 266.2482773, 266.2441716, 
    266.2400659, 266.2359603, 266.2318546, 266.2277489, 266.2236433, 
    266.2195376, 266.2154319, 266.2113263, 266.2071816, 266.2028707, 
    266.1985597, 266.1942488, 266.1899378, 266.1856269, 266.1813159, 
     266.177005,  266.172694, 266.1683831, 266.1640721, 266.1595641, 
    266.1550478, 266.1505316, 266.1460154, 266.1414991, 266.1369829, 
    266.1324667, 266.1279504, 266.1234342,  266.118918, 266.1142447, 
    266.1095134, 266.1047821, 266.1000508, 266.0953195, 266.0905882, 
    266.0858569, 266.0811256, 266.0763943,  266.071663, 266.0668045, 
     266.061819, 266.0568336, 266.0518481, 266.0468627, 266.0418772, 
    266.0368918, 266.0319063, 266.0269209, 266.0219354, 266.0168838, 
    266.0116539, 266.0064241, 266.0011943, 265.9959644, 265.9907346, 
    265.9855047, 265.9802749, 265.9750451, 265.9698152, 265.9645738, 
    265.9590604, 265.9535471, 265.9480338, 265.9425205, 265.9370071, 
    265.9314938, 265.9259805, 265.9204671, 265.9149538, 265.9094405, 
    265.9036813,  265.897865, 265.8920486, 265.8862322, 265.8804159, 
    265.8745995, 265.8687831, 265.8629668, 265.8571504, 265.8513341, 
    265.8453301, 265.8391912, 265.8330522, 265.8269132, 265.8207743, 
    265.8146353, 265.8084964, 265.8023574, 265.7962185, 265.7900795, 
    265.7838168, 265.7773259, 265.7708351, 265.7643442, 265.7578533, 
    265.7513625, 265.7448716, 265.7383807, 265.7318899,  265.725399, 
    265.7188616, 265.7119895, 265.7051174, 265.6982453, 265.6913732, 
    265.6845011,  265.677629, 265.6707569, 265.6638848, 265.6570127, 
    265.6501406, 265.6428847, 265.6355825, 265.6282802,  265.620978, 
    265.6136758, 265.6063736, 265.5990713, 265.5917691, 265.5844669, 
    265.5771647, 265.5695646, 265.5618127, 265.5540608, 265.5463089, 
     265.538557, 265.5308051, 265.5230532, 265.5153013, 265.5075494, 
    265.4997975, 265.4918214, 265.4835515, 265.4752815, 265.4670115, 
    265.4587415, 265.4504715, 265.4422015, 265.4339315, 265.4256615, 
    265.4173915, 265.4090085, 265.4001813, 265.3913541, 265.3825269, 
    265.3736997, 265.3648725, 265.3560454, 265.3472182,  265.338391, 
    265.3295638, 265.3207366, 265.3113006, 265.3018477, 265.2923949, 
    265.2829421, 265.2734893, 265.2640365, 265.2545837, 265.2451309, 
    265.2356781, 265.2262253, 265.2162492, 265.2060925, 265.1959359, 
    265.1857793, 265.1756226,  265.165466, 265.1553093, 265.1451527, 
    265.1349961, 265.1248394, 265.1142811, 265.1033424, 265.0924037, 
     265.081465, 265.0705264, 265.0595877,  265.048649, 265.0377104, 
    265.0267717,  265.015833, 265.0046418, 264.9928135, 264.9809853, 
    264.9691571, 264.9573288, 264.9455006, 264.9336724, 264.9218441, 
    264.9100159, 264.8981877, 264.8863044, 264.8734595, 264.8606146, 
    264.8477697, 264.8349249,   264.82208, 264.8092351, 264.7963902, 
    264.7835454, 264.7707005, 264.7578556, 264.7440598, 264.7300614, 
    264.7160631, 264.7020647, 264.6880663, 264.6740679, 264.6600696, 
    264.6460712, 264.6320728, 264.6180744, 264.6032739, 264.5879265, 
    264.5725791, 264.5572318, 264.5418844,  264.526537, 264.5111896, 
    264.4958422, 264.4804949, 264.4651475, 264.4492223, 264.4322913, 
    264.4153603, 264.3984293, 264.3814983, 264.3645673, 264.3476363, 
    264.3307053, 264.3137743, 264.2968433, 264.2796588, 264.2608509, 
     264.242043, 264.2232351, 264.2044273, 264.1856194, 264.1668115, 
    264.1480037, 264.1291958, 264.1103879, 264.0915801, 264.0707455, 
     264.049699, 264.0286526, 264.0076062, 263.9865597, 263.9655133, 
    263.9444669, 263.9234204,  263.902374, 263.8813276, 263.8584121, 
    263.8345992, 263.8107864, 263.7869735, 263.7631606, 263.7393477, 
    263.7155349,  263.691722, 263.6679091, 263.6440962, 263.6187536, 
    263.5915096, 263.5642655, 263.5370215, 263.5097775, 263.4825334, 
    263.4552894, 263.4280453, 263.4008013, 263.3735573, 263.3453648, 
    263.3137316, 263.2820984, 263.2504652,  263.218832, 263.1871989, 
    263.1555657, 263.1239325, 263.0922993, 263.0606661, 263.0290329, 
    262.9916918, 262.9542716, 262.9168514, 262.8794311, 262.8420109, 
    262.8045907, 262.7671704, 262.7297502,   262.69233, 262.6549097, 
    262.6115064, 262.5661779, 262.5208494, 262.4755208, 262.4301923, 
    262.3848638, 262.3395352, 262.2942067, 262.2488782, 262.2035496, 
    262.1553266, 262.1043708, 262.0515614, 261.9975466, 261.9424691, 
    261.8857555, 261.8276774, 261.7685266, 261.7078403, 261.6456831, 
    261.5824329, 261.5175684, 261.4500092, 261.3807632, 261.3095972, 
    261.2354787, 261.1596844, 261.0822169, 261.0014709, 260.9190597, 
    260.8349247,  260.747594, 260.6567275, 260.5627371, 260.4638992, 
    260.3610124, 260.2549912, 260.1445777, 260.0296962, 259.9116917, 
    259.7897026, 259.6628709, 259.5302834, 259.3895953, 259.2369029, 
     259.077177, 258.9103924, 258.7304878, 258.5435548, 258.3495939, 
    258.1436304, 257.9324787, 257.7074876, 257.4543942, 257.1644781, 
    256.8485523, 256.5066209, 256.1367441, 255.7299044, 255.2970126, 
    254.8233763, 254.2780644, 253.6537254, 252.8724818, 251.9643913, 
     250.905318, 249.6572955,  248.029138, 245.9961652, 243.4271653, 
    240.2199354, 236.3874256,  232.000665, 227.1809639, 221.9982712, 
    216.3880646, 209.9601387, 202.7963145, 195.4539838, 188.0073079, 
    180.4665037,  172.845769, 165.1549452, 157.4076183, 149.6233052, 
    141.8342876, 134.0995132, 126.5283185, 119.3052429, 112.6798634, 
    106.8936253, 102.0389032, 98.10478465, 95.10624309, 93.05480398, 
    91.71972688, 90.83327918,  90.1748951, 89.60351706, 89.11913547, 
    88.73167624, 88.43382933, 88.18992079, 87.95052801, 87.73005392, 
    87.52402011, 87.33076872, 87.15143722, 86.99154166,  86.8444332, 
    86.71010912, 86.59249875, 86.47490531, 86.36366993, 86.25715013, 
    86.15394088, 86.05496605,   85.961186, 85.87071443, 85.78398645, 
     85.7029557, 85.62522908, 85.55075178, 85.47910497, 85.40898928, 
    85.34040495, 85.27443087, 85.21021358, 85.14752656, 85.08721699, 
    85.02889604, 84.97210688, 84.91746866, 84.86794093, 84.81993491, 
     84.7719289, 84.72392289, 84.67591687, 84.62791086, 84.57990484, 
    84.53189883, 84.48389282,  84.4358868,  84.3928019, 84.35391047, 
    84.31501904, 84.27612761, 84.23723618, 84.19834475, 84.15945332, 
    84.12056188, 84.08167045, 84.04277902,  84.0057698, 83.97294693, 
    83.94012407, 83.90730121, 83.87447835, 83.84165549, 83.80883262, 
    83.77600976,  83.7431869, 83.71036404, 83.67788886, 83.64939063, 
    83.62089241, 83.59239418, 83.56389596, 83.53539774, 83.50689951, 
    83.47840129, 83.44990306, 83.42140484, 83.39290661,  83.3671566, 
    83.34188914, 83.31662169, 83.29135423, 83.26608678, 83.24081932, 
    83.21555187, 83.19028441, 83.16501696,  83.1397495,   83.116037, 
    83.09327401, 83.07051101, 83.04774801, 83.02498501, 83.00222202, 
    82.97945902, 82.95669602, 82.93393302, 82.91117003,  82.8891866, 
    82.86841681, 82.84764702, 82.82687722, 82.80610743, 82.78533764, 
    82.76456784, 82.74379805, 82.72302826, 82.70225846, 82.68175145, 
    82.66261024, 82.64346903, 82.62432782, 82.60518661, 82.58604539, 
    82.56690418, 82.54776297, 82.52862176, 82.50948055, 82.49033934, 
    82.47245576, 82.45466454, 82.43687331, 82.41908208, 82.40129085, 
    82.38349962, 82.36570839, 82.34791716, 82.33012593, 82.31233471, 
    82.29534344, 82.27869202,  82.2620406, 82.24538919, 82.22873777, 
    82.21208635, 82.19543494, 82.17878352,  82.1621321, 82.14548068, 
    82.12928843, 82.11360967,  82.0979309, 82.08225214, 82.06657337, 
    82.05089461, 82.03521584, 82.01953708, 82.00385832, 81.98817955, 
    81.97270473, 81.95786763, 81.94303053, 81.92819343, 81.91335632, 
    81.89851922, 81.88368212, 81.86884501, 81.85400791, 81.83917081, 
    81.82434294, 81.81024094, 81.79613895, 81.78203696, 81.76793497, 
    81.75383297, 81.73973098, 81.72562899,   81.711527,   81.697425, 
    81.68332301, 81.66972682, 81.65627099, 81.64281515, 81.62935931, 
    81.61590347, 81.60244763, 81.58899179, 81.57553595, 81.56208012, 
    81.54862428, 81.53548578, 81.52260376, 81.50972173, 81.49683971, 
    81.48395769, 81.47107567, 81.45819364, 81.44531162,  81.4324296, 
    81.41954758, 81.40683083, 81.39446006, 81.38208929, 81.36971852, 
    81.35734775, 81.34497698, 81.33260621, 81.32023544, 81.30786467, 
    81.29549391, 81.28316619, 81.27125585,  81.2593455, 81.24743515, 
     81.2355248, 81.22361445, 81.21170411, 81.19979376, 81.18788341, 
    81.17597306, 81.16406271, 81.15251122, 81.14101632, 81.12952143, 
    81.11802654, 81.10653164, 81.09503675, 81.08354186, 81.07204696, 
    81.06055207, 81.04905718, 81.03780089, 81.02668235, 81.01556381, 
    81.00444527, 80.99332673, 80.98220819, 80.97108965, 80.95997111, 
    80.94885257, 80.93773403, 80.92675458, 80.91598014, 80.90520569, 
    80.89443124,  80.8836568, 80.87288235,  80.8621079, 80.85133346, 
    80.84055901, 80.82978457, 80.81906504, 80.80860536, 80.79814568, 
      80.787686, 80.77722632, 80.76676665, 80.75630697, 80.74584729, 
    80.73538761, 80.72492793, 80.71446825, 80.70428193,  80.6941116, 
    80.68394128, 80.67377095, 80.66360062,  80.6534303, 80.64325997, 
    80.63308964, 80.62291932, 80.61274899, 80.60276946, 80.59286601, 
    80.58296255, 80.57305909, 80.56315563, 80.55325217, 80.54334872, 
    80.53344526,  80.5235418, 80.51363834, 80.50385393, 80.49419584, 
    80.48453774, 80.47487964, 80.46522155, 80.45556345, 80.44590536, 
    80.43624726, 80.42658917, 80.41693107, 80.40733165, 80.39790328, 
    80.38847491, 80.37904653, 80.36961816, 80.36018979, 80.35076141, 
    80.34133304, 80.33190467, 80.32247629, 80.31305339, 80.30383812, 
    80.29462285, 80.28540758, 80.27619231, 80.26697704, 80.25776177, 
     80.2485465, 80.23933123, 80.23011596, 80.22090069, 80.21184258, 
    80.20282478, 80.19380697, 80.18478916, 80.17577136, 80.16675355, 
    80.15773574, 80.14871794, 80.13970013, 80.13068232, 80.12176967, 
    80.11293759, 80.10410552, 80.09527345, 80.08644137,  80.0776093, 
    80.06877722, 80.05994515, 80.05111307,   80.042281, 80.03350746, 
    80.02484939, 80.01619132, 80.00753324, 79.99887517,  79.9902171, 
    79.98155903, 79.97290096, 79.96424288, 79.95558481, 79.94694415, 
    79.93844932,  79.9299545, 79.92145968, 79.91296486, 79.90447003, 
    79.89597521, 79.88748039, 79.87898556, 79.87049074, 79.86199592, 
    79.85363653, 79.84529616, 79.83695579, 79.82861541, 79.82027504, 
    79.81193467,  79.8035943, 79.79525393, 79.78691356, 79.77857318, 
    79.77032517, 79.76212752, 79.75392987, 79.74573222, 79.73753457, 
    79.72933692, 79.72113927, 79.71294161, 79.70474396, 79.69654631, 
    79.68840619, 79.68034637, 79.67228655, 79.66422673, 79.65616692, 
     79.6481071, 79.64004728, 79.63198746, 79.62392765, 79.61586783, 
    79.60783222, 79.59990144, 79.59197065, 79.58403987, 79.57610909, 
    79.56817831, 79.56024752, 79.55231674, 79.54438596, 79.53645518, 
    79.52852439, 79.52071065, 79.51290206, 79.50509347, 79.49728488, 
    79.48947629,  79.4816677, 79.47385911, 79.46605052, 79.45824193, 
    79.45043334, 79.44270945, 79.43501719, 79.42732492, 79.41963266, 
     79.4119404, 79.40424814, 79.39655587, 79.38886361, 79.38117135, 
    79.37347909, 79.36584138,  79.3582586, 79.35067582, 79.34309305, 
    79.33551027, 79.32792749, 79.32034471, 79.31276193, 79.30517916, 
    79.29759638, 79.29004195, 79.28256475, 79.27508755, 79.26761034, 
    79.26013314, 79.25265593, 79.24517873, 79.23770153, 79.23022432, 
    79.22274712, 79.21527375, 79.20789527,  79.2005168, 79.19313833, 
    79.18575986, 79.17838138, 79.17100291, 79.16362444, 79.15624597, 
     79.1488675, 79.14148902, 79.13418806, 79.12690538, 79.11962271, 
    79.11234004, 79.10505736, 79.09777469, 79.09049202, 79.08320934, 
    79.07592667,   79.068644, 79.06141399, 79.05422222, 79.04703046, 
     79.0398387, 79.03264694, 79.02545518, 79.01826341, 79.01107165, 
    79.00387989, 78.99668813, 78.98952677, 78.98242201, 78.97531725, 
    78.96821249, 78.96110773, 78.95400297, 78.94689821, 78.93979345, 
    78.93268868, 78.92558392, 78.91848911, 78.91146744, 78.90444577, 
     78.8974241, 78.89040243, 78.88338076, 78.87635909, 78.86933742, 
    78.86231575, 78.85529408, 78.84827241, 78.84130905, 78.83435289, 
    78.82739673, 78.82044057, 78.81348442, 78.80652826,    78.79957, 
};

static bool new_shape = false;

void set_shape(bool a_new_shape)
{
    new_shape = a_new_shape;
}

float waveshape(float input)
{
    float output;
    const float *shape = new_shape ? EXTENDED_SHAPE : SHAPE;
    size_t shape_size = new_shape ? ARRAY_LENGTH(EXTENDED_SHAPE) : ARRAY_LENGTH(SHAPE);

    //calculate which sample of shape the input sample corresponds to
    //the first sample is -1, last is 1

    // this keeps the level the same when using the extended waveshaper
    float scaled_input = input * (new_shape ? 0.1 : 1);
    float index = (scaled_input + 1.0f) / 2.0f * (shape_size - 1);

    //if input is out of range, hard clip
    if(index <= 0)
    {
        output = shape[0];
    }
    else if((int)index + 1 > (int)(shape_size - 1))
    {
        output = shape[shape_size - 1];
    }
    else
    {
        // linear interpolation between two nearest elements in shape.
        // conversion to int rounds down
        float ratio = index - ((int)index);
        output = shape[(int)index] + ratio*(shape[((int)index) + 1] - shape[(int)index]);
    }

    return (output - shape[shape_size/2])/300.0f;
}
