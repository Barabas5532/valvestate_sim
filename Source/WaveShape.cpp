/*
    Copyright 2020 Barabas Raffai

    This file is part of Valvestate Sim.

    Valvestate Sim is free software: you can redistribute it and/or modify it
    under the terms of the GNU General Public License as published by the Free
    Software Foundation, either version 3 of the License, or (at your option)
    any later version.

    Valvestate Sim is distributed in the hope that it will be useful, but
    WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
    or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
    for more details.

    You should have received a copy of the GNU General Public License along
    with Valvestate Sim.  If not, see <https://www.gnu.org/licenses/>.
*/

#include "WaveShape.h"
#include <math.h>
#include <stddef.h>

#define ARRAY_LENGTH(a) (sizeof(a)/sizeof(a[0]))

/* Shorter shape, with 100 points */
static const float SHAPE_SMALL[] = {
        260.874, 260.7859598, 260.6953072,  260.601432, 260.5041537,
    260.4031856, 260.2985207, 260.1896056,  260.076319, 259.9582966,
    259.8351546, 259.7065092, 259.5718914, 259.4308215, 259.2828199,
    259.1270814, 258.9629027, 258.7895337, 258.6060523, 258.4113474,
    258.2040441, 257.9827768, 257.7457712, 257.4909677,  257.215841,
    256.9175018, 256.5922455, 256.2355875, 255.8419352, 255.4041851,
    254.9131986, 254.3570307, 253.7197414, 252.9797121, 252.1071154,
    251.0601723, 249.8186298, 248.2374011, 246.2379769, 243.6984809,
    240.5224287, 236.6969109, 232.3051762, 227.4657723, 222.2539886,
    216.6160464, 210.1628519, 202.9424278, 195.5356801, 188.0209338,
    180.4120106, 172.7204129, 164.9578739,  157.138341, 149.2820719,
    141.4227325, 133.6224484, 125.9975098, 118.7442167, 112.1250619,
    106.3720184,  101.573245,  97.7060744, 94.80219447, 92.84731645,
     91.5876897, 90.69125858,  90.0247106, 89.50066273, 89.07172653,
    88.71016277, 88.39855163, 88.12531192, 87.88239154, 87.66399733,
    87.46582419, 87.28474325, 87.11794571, 86.96342626, 86.81954855,
    86.68498918, 86.55863586,  86.4395753, 86.32702159, 86.22032926,
    86.11890837, 86.02227577, 85.93001157, 85.84172799, 85.75711414,
    85.67586468,  85.5977274, 85.52247784, 85.44990292, 85.37981384,
    85.31205745, 85.24646844, 85.18291616, 85.12127864,    85.06124,
};

static const float SHAPE_LARGE[] = {
    260.874, 260.8652763, 260.8565525, 260.8478288, 260.8391051, 
    260.8303814, 260.8216576, 260.8129339, 260.8042102, 260.7954865, 
    260.7867627, 260.7777929, 260.7688093, 260.7598257, 260.7508422, 
    260.7418586,  260.732875, 260.7238914, 260.7149078, 260.7059242, 
    260.6969406, 260.6877256, 260.6784195, 260.6691133, 260.6598071, 
    260.6505009, 260.6411947, 260.6318886, 260.6225824, 260.6132762, 
    260.60397, 260.5944971, 260.5848487, 260.5752004, 260.5655521, 
    260.5559038, 260.5462555, 260.5366071, 260.5269588, 260.5173105, 
    260.5076622, 260.4979181, 260.4878984, 260.4778786, 260.4678588, 
    260.457839, 260.4478192, 260.4377994, 260.4277796, 260.4177599, 
    260.4077401, 260.3977099, 260.3873187, 260.3769274, 260.3665362, 
    260.3561449, 260.3457537, 260.3353624, 260.3249712, 260.3145799, 
    260.3041887, 260.2937974, 260.2830629, 260.2722415, 260.2614201, 
    260.2505988, 260.2397774,  260.228956, 260.2181347, 260.2073133, 
    260.1964919, 260.1856705, 260.1745991, 260.1633379, 260.1520766, 
    260.1408154, 260.1295541, 260.1182928, 260.1070316, 260.0957703, 
    260.0845091, 260.0732478, 260.0618243, 260.0500841, 260.0383438, 
    260.0266036, 260.0148633,  260.003123, 259.9913828, 259.9796425, 
    259.9679023,  259.956162, 259.9443654,  259.932107, 259.9198487, 
    259.9075903,  259.895332, 259.8830736, 259.8708152, 259.8585569, 
    259.8462985, 259.8340402, 259.8217818, 259.8090336, 259.7962181, 
    259.7834025,  259.770587, 259.7577714, 259.7449559, 259.7321403, 
    259.7193248, 259.7065092, 259.6936937, 259.6804846,  259.667063, 
    259.6536413, 259.6402197, 259.6267981, 259.6133765, 259.5999548, 
    259.5865332, 259.5731116,   259.55969, 259.5459935, 259.5319169, 
    259.5178404, 259.5037638, 259.4896872, 259.4756106, 259.4615341, 
    259.4474575, 259.4333809, 259.4193043, 259.4050941, 259.3903137, 
    259.3755333, 259.3607529, 259.3459725, 259.3311921, 259.3164117, 
    259.3016313, 259.2868509, 259.2720705, 259.2572901, 259.2417495, 
    259.2261773, 259.2106051, 259.1950329, 259.1794606, 259.1638884, 
    259.1483162,  259.132744, 259.1171718, 259.1015996, 259.0853991, 
    259.0689667, 259.0525342, 259.0361018, 259.0196693, 259.0032369, 
    258.9868044,  258.970372, 258.9539395, 258.9375071, 258.9206049, 
    258.903234, 258.8858631, 258.8684922, 258.8511214, 258.8337505, 
    258.8163796, 258.7990087, 258.7816378, 258.7642669, 258.7466154, 
    258.7282084, 258.7098013, 258.6913942, 258.6729871,   258.65458, 
    258.636173, 258.6177659, 258.5993588, 258.5809517, 258.5624973, 
    258.5429367, 258.5233762, 258.5038156,  258.484255, 258.4646944, 
    258.4451339, 258.4255733, 258.4060127, 258.3864521, 258.3668916, 
    258.3462762, 258.3254155, 258.3045548, 258.2836941, 258.2628334, 
    258.2419727,  258.221112, 258.2002513, 258.1793906, 258.1585299, 
    258.1368335, 258.1145359, 258.0922382, 258.0699405, 258.0476428, 
    258.0253451, 258.0030474, 257.9807497,  257.958452, 257.9361543, 
    257.9132824, 257.8893522, 257.8654221, 257.8414919, 257.8175617, 
    257.7936315, 257.7697013, 257.7457712,  257.721841, 257.6979108, 
    257.6737552, 257.6479775, 257.6221998,  257.596422, 257.5706443, 
    257.5448666, 257.5190888, 257.4933111, 257.4675334, 257.4417556, 
    257.4159779, 257.3883075, 257.3604085, 257.3325095, 257.3046105, 
    257.2767115, 257.2488126, 257.2209136, 257.1930146, 257.1651156, 
    257.1372166, 257.1077115, 257.0773883,  257.047065, 257.0167417, 
    256.9864184, 256.9560951, 256.9257718, 256.8954485, 256.8651252, 
    256.8348019, 256.8032519, 256.7700938, 256.7369356, 256.7037775, 
    256.6706193, 256.6374611,  256.604303, 256.5711448, 256.5379867, 
    256.5048285, 256.4709978, 256.4345258, 256.3980538, 256.3615817, 
    256.3251097, 256.2886377, 256.2521657, 256.2156937, 256.1792216, 
    256.1427496, 256.1062776, 256.0659812, 256.0255795, 255.9851777, 
    255.944776, 255.9043743, 255.8639726, 255.8235708, 255.7831691, 
    255.7427674, 255.7023656,  255.658461, 255.6133476, 255.5682341, 
    255.5231206, 255.4780071, 255.4328937, 255.3877802, 255.3426667, 
    255.2975532, 255.2524398, 255.2043838, 255.1535419,    255.1027, 
    255.0518582, 255.0010163, 254.9501745, 254.8993326, 254.8484908, 
    254.7976489,  254.746807, 254.6939586, 254.6360491, 254.5781396, 
    254.5202302, 254.4623207, 254.4044112, 254.3465017, 254.2885923, 
    254.2306828, 254.1727733, 254.1143832, 254.0475976, 253.9808121, 
    253.9140266,  253.847241, 253.7804555,   253.71367, 253.6468844, 
    253.5800989, 253.5133133, 253.4465278,  253.370386, 253.2922512, 
    253.2141165, 253.1359817, 253.0578469, 252.9797121, 252.9015774, 
    252.8234426, 252.7453078,  252.667173, 252.5802377, 252.4873029, 
    252.3943682, 252.3014335, 252.2084987,  252.115564, 252.0226293, 
    251.9296946, 251.8367598, 251.7438251, 251.6437104, 251.5310978, 
    251.4184851, 251.3058725, 251.1932599, 251.0806473, 250.9680347, 
    250.8554221, 250.7428095, 250.6301969, 250.5157806, 250.3898188, 
    250.2608512,  250.129494, 249.9946965, 249.8565883, 249.7161129, 
    249.572548, 249.4252643, 249.2756277, 249.1232955, 248.9662963, 
    248.8062414, 248.6428815, 248.4736495, 248.3011634, 248.1254358, 
    247.9442673,  247.759449, 247.5713857, 247.3782307, 247.1803778, 
    246.9787043, 246.7709599,  246.557315, 246.3394736, 246.1161809, 
    245.8864197, 245.6524531, 245.4136121, 245.1676829, 244.9170955, 
    244.6616103,  244.397009, 244.1274501, 243.8529302, 243.5697731, 
    243.2810543,  242.987369, 242.6857868, 242.3778611,  242.064847, 
    241.7438808, 241.4158713, 241.0827907,  240.743057, 240.3954769, 
    240.0428292,  239.684328,  239.317229, 238.9450624, 238.5677937, 
    238.181306, 237.7904678, 237.3952649, 236.9925161,  236.584866, 
    236.1728512, 235.7539377, 235.3294758, 234.9006491, 234.4655708, 
    234.0253383, 233.5811009,  233.133138, 232.6792883, 232.2215699, 
    231.7601014, 231.2943544, 230.8232494, 230.3483809, 229.8701614, 
    229.3870613,  228.901046, 228.4114887, 227.9176234, 227.4204328, 
    226.9199398, 226.4161623, 225.9081737,  225.396461, 224.8816328, 
    224.3636113, 223.8428234,  223.316873, 222.7872569, 222.2539886, 
    221.7170775, 221.1756761,  220.629941, 220.0805813, 219.5272129, 
    218.9683275, 218.4044336, 217.8334032, 217.2551436, 216.6696549, 
    216.0768881, 215.4768897, 214.8684602, 214.2480835, 213.6162527, 
    212.9732967, 212.3184535, 211.6525191, 210.9757415,  210.288744, 
    209.5938309, 208.8917198, 208.1838805,  207.471808, 206.7558759, 
    206.0371172, 205.3157907, 204.5926596, 203.8676937, 203.1409168, 
    202.4127591, 201.6833485, 200.9526808, 200.2208266, 199.4875635, 
    198.7530694, 198.0175231, 197.2810681, 196.5432298, 195.8045778, 
    195.0651091,  194.324068, 193.5822499, 192.8396496, 192.0956603, 
    191.3506971, 190.6049775, 189.8580429, 189.1102125, 188.3616638, 
    187.6120578,  186.861452, 186.1101434, 185.3579347, 184.6046219, 
    183.8505797, 183.0956997, 182.3396285, 181.5829817, 180.8257044, 
    180.0672644, 179.3081955, 178.5485032, 177.7878012, 177.0263364, 
    176.2642167, 175.5011173, 174.7372866, 173.9728719, 173.2077177, 
    172.4418263, 171.6753959, 170.9082553, 170.1403008, 169.3718018, 
    168.6026749, 167.8326572, 167.0621559, 166.2911796, 165.5193823, 
    164.747178, 163.9745668, 163.2012617, 162.4274478, 161.6532009, 
    160.8783204, 160.1028653, 159.3270552, 158.5506679, 157.7739644, 
    156.9970178, 156.2197401, 155.4421133, 154.6642112, 153.8859745, 
    153.1073559, 152.3284831, 151.5493404, 150.7699664, 149.9905931, 
    149.2112198, 148.4318465, 147.6526084, 146.8733821, 146.0941705, 
    145.3150178, 144.5358651, 143.7570131, 142.9784174, 142.2002504, 
    141.4227325, 140.6459025, 139.8699187, 139.0945511, 138.3198185, 
    137.5457502, 136.7725712, 136.0007214, 135.2298153, 134.4599936, 
    133.6921552, 132.9266585, 132.1629509, 131.4010641, 130.6410154, 
    129.8832863,  129.127505, 128.3742391, 127.6239778, 126.8755728, 
    126.1325025, 125.3928886, 124.6567288, 123.9260891, 123.1993188, 
    122.476015, 121.7571951, 121.0433273, 120.3332683, 119.6301018, 
    118.9332247,  118.241822, 117.5589299, 116.8832349, 116.2130388, 
    115.5504897, 114.8959601, 114.2469131, 113.6047069, 112.9734534, 
    112.3491516, 111.7329049, 111.1289615, 110.5321249, 109.9423909, 
    109.3657341, 108.7963209, 108.2340158, 107.6837295, 107.1426412, 
    106.609228, 106.0873669,  105.575156,   105.07038, 104.5760538, 
    104.0924266, 103.6162412, 103.1494499, 102.6944544, 102.2464282, 
    101.8067848, 101.3786284, 100.9590404, 100.5474504, 100.1438569, 
    99.75217857, 99.36864982, 98.99309484, 98.62574022,  98.2695069, 
    97.9208773, 97.58332988, 97.25523896, 96.93654474, 96.62725654, 
    96.32736975, 96.03687822, 95.75554873, 95.48545578, 95.22521376, 
    94.97853863, 94.73861957, 94.50566175, 94.28543077, 94.07231151, 
    93.86615303,  93.6716966,   93.485384, 93.30603045, 93.13734172, 
    92.97615897, 92.82002568, 92.66992641, 92.52603965, 92.38644586, 
    92.25224421, 92.12489122, 92.00183451, 91.88353733, 91.77272496, 
    91.67115029, 91.57934364, 91.48753699, 91.39573034, 91.30392369, 
    91.21211704, 91.12031039, 91.02850374, 90.93669709, 90.84489044, 
    90.75893172, 90.69125858, 90.62358544,  90.5559123, 90.48823915, 
    90.42056601, 90.35289287, 90.28521973, 90.21754659, 90.14987344, 
    90.08238618,  90.0295169, 89.97664763, 89.92377835, 89.87090908, 
    89.8180398, 89.76517053, 89.71230125, 89.65943197,  89.6065627, 
    89.55369342, 89.50849389,  89.4654225, 89.42235111, 89.37927972, 
    89.33620832, 89.29313693, 89.25006554, 89.20699415, 89.16392276, 
    89.12085137, 89.08159293, 89.04541613, 89.00923933, 88.97306252, 
    88.93688572, 88.90070892, 88.86453212, 88.82835532, 88.79217852, 
    88.75600171, 88.72146882, 88.69037718, 88.65928555, 88.62819391, 
    88.59710227, 88.56601063, 88.53491899, 88.50382735, 88.47273571, 
    88.44164408, 88.41091618, 88.38371417, 88.35651217, 88.32931016, 
    88.30210815, 88.27490615, 88.24770414, 88.22050213, 88.19330013, 
    88.16609812, 88.13889611, 88.11433947,  88.0902001, 88.06606073, 
    88.04192135, 88.01778198,  87.9936426, 87.96950323, 87.94536386, 
    87.92122448, 87.89708511, 87.87451186, 87.85284273,  87.8311736, 
    87.80950447, 87.78783534, 87.76616621, 87.74449708, 87.72282795, 
    87.70115882, 87.67948969,  87.6586413, 87.63900252, 87.61936374, 
    87.59972496, 87.58008618,  87.5604474, 87.54080862, 87.52116984, 
    87.50153106, 87.48189229, 87.46254925, 87.44460553,  87.4266618, 
    87.40871808, 87.39077435, 87.37283063,  87.3548869, 87.33694318, 
    87.31899945, 87.30105573,   87.283112, 87.26652397, 87.25001528, 
    87.23350658, 87.21699788, 87.20048919, 87.18398049, 87.16747179, 
    87.1509631,  87.1344544, 87.11794571, 87.10231692, 87.08703895, 
    87.07176098,   87.056483, 87.04120503, 87.02592706, 87.01064908, 
    86.99537111, 86.98009314, 86.96481516,  86.9500537, 86.93584027, 
    86.92162684,  86.9074134, 86.89319997, 86.87898654, 86.86477311, 
    86.85055968, 86.83634624, 86.82213281, 86.80815709, 86.79487428, 
    86.78159146, 86.76830865, 86.75502584, 86.74174302, 86.72846021, 
    86.71517739, 86.70189458, 86.68861177, 86.67534996, 86.66288535, 
    86.65042073, 86.63795612, 86.62549151, 86.61302689, 86.60056228, 
    86.58809767, 86.57563306, 86.56316844, 86.55070383,  86.5388173, 
    86.527079,  86.5153407,  86.5036024,  86.4918641,  86.4801258, 
    86.46838749, 86.45664919, 86.44491089, 86.43317259, 86.42180067, 
    86.4107095, 86.39961833, 86.38852716, 86.37743599, 86.36634482, 
    86.35525365, 86.34416248, 86.33307131, 86.32198015, 86.31108496, 
    86.30057641, 86.29006785,  86.2795593, 86.26905074, 86.25854219, 
    86.24803363, 86.23752508, 86.22701652, 86.21650797, 86.20605518, 
    86.19606961, 86.18608404, 86.17609846, 86.16611289, 86.15612732, 
    86.14614175, 86.13615618, 86.12617061, 86.11618504, 86.10619946, 
    86.09663048,    86.08712, 86.07760951, 86.06809902, 86.05858853, 
    86.04907805, 86.03956756, 86.03005707, 86.02054659,  86.0110361, 
    86.00180585, 85.99272841, 85.98365097, 85.97457354,  85.9654961, 
    85.95641866, 85.94734123, 85.93826379, 85.92918635, 85.92010891, 
    85.91119589, 85.90251241, 85.89382892, 85.88514543, 85.87646194, 
    85.86777845, 85.85909497, 85.85041148, 85.84172799,  85.8330445, 
    85.82442923, 85.81610939, 85.80778954,  85.7994697, 85.79114986, 
    85.78283002, 85.77451017, 85.76619033, 85.75787049, 85.74955064, 
    85.7412308, 85.73322931, 85.72524183, 85.71725435, 85.70926687, 
    85.70127939, 85.69329191, 85.68530443, 85.67731695, 85.66932947, 
    85.66134199,  85.6535787, 85.64589915, 85.63821959, 85.63054004, 
    85.62286048, 85.61518093, 85.60750137, 85.59982182, 85.59214226, 
    85.58446271,  85.5769254, 85.56953128, 85.56213717, 85.55474306, 
    85.54734894, 85.53995483, 85.53256072, 85.52516661, 85.51777249, 
    85.51037838, 85.50305515, 85.49592497, 85.48879479, 85.48166462, 
    85.47453444, 85.46740426, 85.46027409, 85.45314391, 85.44601373, 
    85.43888356,  85.4317629, 85.42487808, 85.41799327, 85.41110845, 
    85.40422364, 85.39733882, 85.39045401,  85.3835692, 85.37668438, 
    85.36979957, 85.36291475, 85.35621658, 85.34956247, 85.34290835, 
    85.33625424, 85.32960012, 85.32294601, 85.31629189, 85.30963778, 
    85.30298366, 85.29632955, 85.28979888, 85.28335787, 85.27691685, 
    85.27047584, 85.26403483, 85.25759382, 85.25115281,  85.2447118, 
    85.23827079, 85.23182978, 85.22545915, 85.21921951, 85.21297987, 
    85.20674023, 85.20050059, 85.19426096, 85.18802132, 85.18178168, 
    85.17554204,  85.1693024, 85.16308536, 85.15703439, 85.15098341, 
    85.14493244, 85.13888147,  85.1328305, 85.12677952, 85.12072855, 
    85.11467758,  85.1086266, 85.10257563, 85.09665648, 85.09075363, 
    85.08485077, 85.07894792, 85.07304506, 85.06714221,    85.06124, 
};

static bool new_shape = false;

void set_shape(bool a_new_shape)
{
    new_shape = a_new_shape;
}

float waveshape(float input)
{
    float output;
    const float *shape = new_shape ? SHAPE_LARGE : SHAPE_SMALL;
    size_t shape_size = new_shape ? ARRAY_LENGTH(SHAPE_LARGE) : ARRAY_LENGTH(SHAPE_SMALL);

    //if input is out of range, hard clip
    //TODO: maybe it's better if we follow the gradient at the end of the shape
    if(input <= -1)
    {
        output = shape[0];
    }
    else if(input >= 1)
    {
       output = shape[shape_size - 1];
    }
    else
    {
        //calculate which sample of shape the input sample corresponds to
        //the first sample is -1, last is 1
        float index = (input + 1.0f) / 2.0f * (shape_size - 1);

        // linear interpolation between two nearest elements in shape.
        // conversion to int rounds down
        float ratio = index - ((int)index);

        output = shape[(int)index] + ratio*(shape[((int)index) + 1] - shape[(int)index]);
    }

    return (output - shape[shape_size/2])/300.0f;
}
